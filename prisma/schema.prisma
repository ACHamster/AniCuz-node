// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  engineType = "client"
  output   = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id Int @id @default(autoincrement())
  email String @unique

  username String @unique
  avatar String?
  point Int @default(0)
  status UserStatus @default(ACTIVE)
  exp Int @default(0)
  level Int @default(0)

  roleId String?
  role Role? @relation(fields: [roleId], references: [id])

  password String
  refreshTokens RefreshToken[]
  articles Article[]
  likes ArticleLike[]
  uploads Upload[]
  items UserItem[]
  pointLogs PointLog[]
  taskProgress UserTaskProgress[]


  createdAt DateTime @default(now())
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // "admin", "user", "moderator"
  description String?
  isDefault   Boolean  @default(false) // 新注册用户是否默认使用此角色

  // 权限格式为资源:动作 (Resource:Action)
  // 例如 ["article:create", "user:ban"]
  permissions Json     @default("[]")

  users       User[]
}

model LevelRule {
  level       Int      @id
  threshold   Int      // 升级所需最小经验值，如 Lv1=100, Lv2=500

  // 存储该等级特权的配置对象
  // 例如: { "uploadLimit": 5242880, "checkInBonus": 20, "canBuyDecorations": true }
  perks       Json     @default("{}")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RefreshToken {
  id Int @id @default(autoincrement())
  tokenHash String @unique
  // 关联用户
  userId Int
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  // 设备信息
  deviceIp String?
  userAgent String?
  os String?
  broswer String?
  device String?
  // 状态
  isRevoked Boolean @default(false)
  expiresAt DateTime
  revokeAt DateTime?


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Article {
  id Int @id @default(autoincrement())

  // 关联作者
  userId Int
  user User @relation(fields: [userId], references: [id], onDelete: SetNull)

  content Json
  cover String
  title String
  description String

  // 计数字段
  viewCount Int @default(0)
  likeCount Int @default(0)
  likedBy ArticleLike[]

  boardId Int?
  board Board? @relation(fields: [boardId], references: [id])
  tags Tag[]
  status ArticleStatus @default(PUBLISHED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title, description])
  @@index([createdAt])
}

model Tag {
  id Int @id @default(autoincrement())
  name String @unique
  articles Article[]
}

model Board {
  id Int @id @default(autoincrement())
  name String @unique
  description String?
  // url别名
  slug String @unique
  icon String

  articles Article[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ArticleLike {
  articleId Int
  userId Int

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([articleId, userId])
}

model Upload {
  id String @id @default(uuid())

  filename String
  mimeType String
  size Int

  key String
  url String

  uploaderId Int
  uploader User @relation(fields: [uploaderId], references: [id])

  hash String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt()

  @@index([hash])
  @@index([uploaderId])
}

model Item {
  id          String   @id @default(uuid())
  name        String
  description String?
  image       String   // 图片 URL
  price       Int      // 价格 (积分)

  type        ItemType

  isOnSale    Boolean  @default(true) // 是否上架

  // 关联
  userItems   UserItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PointLog {
  id        String   @id @default(uuid())

  userId    Int
  user      User   @relation(fields: [userId], references: [id])

  amount    Int
  reason    String

  createdAt DateTime @default(now())
}

model UserItem {
  id        String   @id @default(uuid())

  userId    Int
  user      User   @relation(fields: [userId], references: [id])

  itemId    String
  item      Item   @relation(fields: [itemId], references: [id])

  isEquipped Boolean @default(false) // 关键：用户是否正在佩戴这个装饰品

  acquiredAt DateTime @default(now())

  @@unique([userId, itemId]) // 防止重复购买同一个永久物品
}

model TaskRule {
  id          String   @id @default(uuid())
  code        String   @unique // 任务标识符，例如: "daily_signin", "post_create"
  name        String
  description String?

  reward      Int
  limit       Int      @default(1) // 周期内最大完成次数 (例如每日限3次)

  // 任务类型：DAILY (每日重置), ONE_TIME (一次性成就), WEEKLY (每周)
  type        TaskType @default(DAILY)

  isActive    Boolean  @default(true)

  progresses  UserTaskProgress[]
}

model UserTaskProgress {
  id          String   @id @default(uuid())

  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  taskRuleId  String
  taskRule    TaskRule @relation(fields: [taskRuleId], references: [id])

  count       Int      @default(0) // 当前周期内已完成次数
  status      TaskStatus @default(IN_PROGRESS) // 进行中 / 已领取 / 已完成

  lastUpdate  DateTime @default(now()) // 上次更新时间，用于判断是否跨天重置

  @@unique([userId, taskRuleId])
}



enum UserStatus {
  ACTIVE
  BANNED
  PENDING
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  BANNED
}

enum ItemType {
  BACKGROUND
  FRAME
  BADGE
}

enum TaskType {
  DAILY
  WEEKLY
  ONE_TIME
}

enum TaskStatus {
  IN_PROGRESS
  COMPLETED
}
